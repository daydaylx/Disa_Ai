name: CI
on:
  push:
  pull_request:
  workflow_dispatch:

jobs:
  verify:
    runs-on: ubuntu-latest
    timeout-minutes: 10
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version-file: .nvmrc
          cache: npm
      - name: Install dependencies
        run: npm ci
      - name: Verify (typecheck + lint + unit tests)
        run: npm run verify

  smoke:
    runs-on: ubuntu-latest
    timeout-minutes: 15
    needs: verify
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version-file: .nvmrc
          cache: npm
      - name: Install dependencies
        run: npm ci
      - name: Run Vitest Smoke
        run: npm run test:smoke
      - name: Get Playwright version
        id: playwright-version
        run: echo "version=$(npm ls @playwright/test --json | jq -r '.dependencies["@playwright/test"].version')" >> $GITHUB_OUTPUT
      - name: Cache Playwright browsers
        uses: actions/cache@v5
        id: playwright-cache
        with:
          path: ~/.cache/ms-playwright
          key: playwright-${{ runner.os }}-${{ steps.playwright-version.outputs.version }}
      - name: Install Playwright browsers
        if: steps.playwright-cache.outputs.cache-hit != 'true'
        run: npx playwright install --with-deps
      - name: Install Playwright deps only
        if: steps.playwright-cache.outputs.cache-hit == 'true'
        run: npx playwright install-deps
      - name: Run Playwright Smoke
        run: npm run e2e:smoke
      - name: Upload Smoke Artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: smoke-test-results
          path: |
            test-results/
            playwright-report/

  # Matrix für Node-Versionen (Workflow-Regel: Node 20 & 22)
  test:
    runs-on: ubuntu-latest
    timeout-minutes: 10
    strategy:
      matrix:
        node-version: [20, 22]
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: ${{ matrix.node-version }}
          cache: "npm"

      - name: Install dependencies
        run: npm ci

      - name: TypeScript Check
        run: npm run typecheck

      - name: Lint
        run: npm run lint

      - name: Unit Tests with Coverage
        run: npm run test:ci

      - name: Upload Coverage Report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: coverage-report-node-${{ matrix.node-version }}
          path: coverage/
          retention-days: 7

  # Bundle-Größe & Performance Budget (Workflow-Regel #17)
  build-and-budget:
    runs-on: ubuntu-latest
    timeout-minutes: 15
    needs: smoke
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: "npm"

      - name: Install dependencies
        run: npm ci

      - name: Build
        run: npm run build

      - name: Check Bundle Size Budget
        run: |
          set -euo pipefail

          find dist/assets/js -name "*.js" -print0 | xargs -0 stat -c "%n %s" | sort -k2 -nr > js-size-report.txt

          ENTRY_LINE=$(grep "index-" js-size-report.txt | head -n 1)
          if [ -z "${ENTRY_LINE}" ]; then
            echo "❌ Kein index-* Bundle gefunden"
            exit 1
          fi
          ENTRY_FILE=$(echo "${ENTRY_LINE}" | awk '{print $1}')
          ENTRY_SIZE=$(echo "${ENTRY_LINE}" | awk '{print $2}')
          ENTRY_KB=$((ENTRY_SIZE / 1024))

          VENDOR_FILE=""
          VENDOR_BYTES=0
          VENDOR_KB=0
          if grep -q "vendor-" js-size-report.txt; then
            VENDOR_FILE=$(grep "vendor-" js-size-report.txt | head -n 1 | awk '{print $1}')
            VENDOR_BYTES=$(grep "vendor-" js-size-report.txt | awk '{sum += $2} END {print sum}')
            VENDOR_KB=$((VENDOR_BYTES / 1024))
          fi

          TOTAL_JS_BYTES=$(awk '{sum += $2} END {print sum}' js-size-report.txt)
          TOTAL_JS_KB=$((TOTAL_JS_BYTES / 1024))

          echo "Entry bundle (${ENTRY_FILE}): ${ENTRY_KB} KB"
          echo "Vendor bundles (sum): ${VENDOR_KB} KB"
          echo "Total JS payload: ${TOTAL_JS_KB} KB"

          MAX_ENTRY_KB=350
          MAX_VENDOR_KB=900
          MAX_TOTAL_JS_KB=2400

          if [ "${ENTRY_KB}" -gt "${MAX_ENTRY_KB}" ]; then
            echo "❌ Entry bundle exceeds ${MAX_ENTRY_KB} KB"
            exit 1
          fi

          if [ -n "${VENDOR_FILE}" ] && [ "${VENDOR_KB}" -gt "${MAX_VENDOR_KB}" ]; then
            echo "❌ Vendor bundles exceed ${MAX_VENDOR_KB} KB"
            exit 1
          fi

          if [ "${TOTAL_JS_KB}" -gt "${MAX_TOTAL_JS_KB}" ]; then
            echo "❌ Total JS payload exceeds ${MAX_TOTAL_JS_KB} KB"
            exit 1
          fi

          echo "✅ Bundle size budget respected"

      - name: Upload Build Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: build-artifacts
          path: |
            dist/
            .audit/
          retention-days: 7

  # Mobile E2E Tests (Workflow-Regel: Mobile-PWA Fokus)
  e2e-mobile:
    runs-on: ubuntu-latest
    timeout-minutes: 15
    needs: build-and-budget
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: "npm"

      - name: Install dependencies
        run: npm ci

      - name: Get Playwright version
        id: playwright-version
        run: echo "version=$(npm ls @playwright/test --json | jq -r '.dependencies["@playwright/test"].version')" >> $GITHUB_OUTPUT

      - name: Cache Playwright browsers
        uses: actions/cache@v5
        id: playwright-cache
        with:
          path: ~/.cache/ms-playwright
          key: playwright-${{ runner.os }}-${{ steps.playwright-version.outputs.version }}

      - name: Install Playwright browsers
        if: steps.playwright-cache.outputs.cache-hit != 'true'
        run: npx playwright install --with-deps

      - name: Install Playwright deps only
        if: steps.playwright-cache.outputs.cache-hit == 'true'
        run: npx playwright install-deps

      - name: Run Mobile E2E Tests
        run: npm run e2e

      - name: Upload E2E Reports
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: playwright-report
          path: playwright-report/
          retention-days: 30

  # Lighthouse Mobile Audit (Performance Budget)
  lighthouse-mobile:
    runs-on: ubuntu-latest
    timeout-minutes: 10
    needs: build-and-budget
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: "npm"

      - name: Install dependencies
        run: npm ci

      - name: Download build artifacts
        uses: actions/download-artifact@v4
        with:
          name: build-artifacts
          path: .

      - name: Run Lighthouse Mobile CI
        run: npm run lh

      - name: Check Mobile Performance Budget
        run: |
          # LCP < 2.5s Check (Lighthouse returns value in milliseconds)
          LCP_MS=$(jq -r '.audits."largest-contentful-paint".numericValue' .lighthouseci/lhr-*.json | head -1)
          # Convert to integer for comparison
          LCP_MS_INT=$(printf "%.0f" "$LCP_MS")
          echo "Mobile LCP: ${LCP_MS_INT} ms"

          if [ "$LCP_MS_INT" -gt 2500 ]; then
            echo "❌ Mobile LCP ${LCP_MS_INT}ms exceeds 2500ms limit!"
            exit 1
          else
            echo "✅ Mobile LCP ${LCP_MS_INT}ms is within 2500ms limit"
          fi

      - name: Upload Lighthouse Reports
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: lighthouse-reports
          path: .lighthouseci/
          retention-days: 30
